name: 🧪 Test Modular Workflows

on:
  workflow_dispatch:
    inputs:
      test_target:
        description: 'Which module to test'
        required: true
        type: choice
        options:
          - 'lighthouse'
          - 'accessibility'
          - 'performance'
          - 'context7'
          - 'all'
        default: 'all'
      target_url:
        description: 'URL to test (for lighthouse/accessibility/performance)'
        required: false
        type: string
        default: 'https://rafilkmp3.github.io/resume-as-code/'

permissions:
  contents: read
  pull-requests: write

jobs:
  test-lighthouse:
    if: inputs.test_target == 'lighthouse' || inputs.test_target == 'all'
    name: 🚀 Test Lighthouse Module
    uses: ./.github/workflows/lighthouse-testing.yml
    with:
      target_url: ${{ inputs.target_url }}
      environment_name: 'testing'
      budget_path: './budget.json'
      artifact_retention_days: 1

  test-accessibility:
    if: inputs.test_target == 'accessibility' || inputs.test_target == 'all'
    name: ♿ Test Accessibility Module
    uses: ./.github/workflows/accessibility-testing.yml
    with:
      target_url: ${{ inputs.target_url }}
      environment_name: 'testing'
      artifact_retention_days: 1

  test-performance:
    if: inputs.test_target == 'performance' || inputs.test_target == 'all'
    name: ⚡ Test Performance Module
    uses: ./.github/workflows/performance-testing.yml
    with:
      target_url: ${{ inputs.target_url }}
      environment_name: 'testing'
      budget_path: './budget.json'
      artifact_retention_days: 1

  test-context7:
    if: inputs.test_target == 'context7' || inputs.test_target == 'all'
    name: 🔄 Test Context7 Module
    uses: ./.github/workflows/context7-updater.yml
    with:
      update_target: 'dependencies'
      dry_run: true

  test-summary:
    name: 📋 Test Summary
    runs-on: ubuntu-latest
    needs: [test-lighthouse, test-accessibility, test-performance, test-context7]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "# 🧪 Modular Workflow Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Target:** ${{ inputs.test_target }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## 📊 Module Test Status" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Check lighthouse test
          if [[ "${{ needs.test-lighthouse.result }}" == "success" ]]; then
            echo "| Lighthouse | ✅ Passed | Performance testing module working" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-lighthouse.result }}" == "skipped" ]]; then
            echo "| Lighthouse | ⏭️ Skipped | Not selected for testing" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Lighthouse | ❌ Failed | Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check accessibility test
          if [[ "${{ needs.test-accessibility.result }}" == "success" ]]; then
            echo "| Accessibility | ✅ Passed | WCAG testing module working" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-accessibility.result }}" == "skipped" ]]; then
            echo "| Accessibility | ⏭️ Skipped | Not selected for testing" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Accessibility | ❌ Failed | Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check performance test
          if [[ "${{ needs.test-performance.result }}" == "success" ]]; then
            echo "| Performance | ✅ Passed | Core Web Vitals module working" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-performance.result }}" == "skipped" ]]; then
            echo "| Performance | ⏭️ Skipped | Not selected for testing" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Performance | ❌ Failed | Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check Context7 test
          if [[ "${{ needs.test-context7.result }}" == "success" ]]; then
            echo "| Context7 | ✅ Passed | Documentation updater working" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-context7.result }}" == "skipped" ]]; then
            echo "| Context7 | ⏭️ Skipped | Not selected for testing" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Context7 | ❌ Failed | Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🎯 Phase 1 Progress" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Modular workflows created** - 7 workflow modules completed" >> $GITHUB_STEP_SUMMARY
          echo "🔄 **Testing in progress** - Individual module validation" >> $GITHUB_STEP_SUMMARY
          echo "⏳ **Integration pending** - Update shared-comprehensive-testing.yml next" >> $GITHUB_STEP_SUMMARY