name: 🔍 Divergence Protection

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allow manual divergence checks

permissions:
  contents: read

jobs:
  divergence-check:
    name: 🔍 Divergence Check
    runs-on: ubuntu-latest
    # Skip divergence check for Release Please PRs as they are expected to diverge
    if: ${{ !startsWith(github.head_ref, 'release-please--') }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Check out the actual PR branch, not the merge commit
          ref: ${{ github.head_ref }}
      - name: Check for divergence from base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # Check how many commits behind and ahead we are
          BEHIND=$(git rev-list --count HEAD..origin/${{ github.base_ref }})
          AHEAD=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)
          
          echo "📊 Branch status:"
          echo "  • Behind main: $BEHIND commits"
          echo "  • Ahead of main: $AHEAD commits"
          
          # Fail if branch is behind (requires update)
          if [ "$BEHIND" -gt 0 ]; then
            echo ""
            echo "❌ DIVERGENCE DETECTED: Branch is $BEHIND commits behind ${{ github.base_ref }}"
            echo "🔄 Required action: Update branch with latest changes from main"
            echo "💡 Use 'Update branch' button or run: git pull origin ${{ github.base_ref }}"
            
            # Show which commits are missing
            echo ""
            echo "📋 Missing commits from ${{ github.base_ref }}:"
            git log --oneline HEAD..origin/${{ github.base_ref }} | head -5
            
            exit 1
          fi
          
          echo ""
          if [ "$AHEAD" -gt 0 ]; then
            echo "✅ Branch is ahead by $AHEAD commits and ready to merge"
            echo "🚀 No update needed - branch contains new changes"
          else
            echo "✅ Branch is up-to-date with ${{ github.base_ref }}"
            echo "💡 No new commits to merge"
          fi

  release-please-check:
    name: 🔍 Release Please - Divergence Allowed
    runs-on: ubuntu-latest
    # Only run for Release Please PRs
    if: ${{ startsWith(github.head_ref, 'release-please--') }}
    steps:
      - name: Release Please PR - Skip Divergence Check
        run: |
          echo "🚀 RELEASE PLEASE PR DETECTED"
          echo "=============================="
          echo ""
          echo "✅ This is a Release Please PR - divergence is expected and allowed"
          echo "📋 Release Please PRs contain new version commits and CHANGELOG updates"
          echo "🔄 No branch update required - ready for manual review and merge"
          echo ""
          echo "💡 Action: Review the release notes and merge when ready to release"