name: ğŸ” Divergence Protection

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allow manual divergence checks

permissions:
  contents: read

jobs:
  divergence-check:
    name: ğŸ” Divergence Check
    runs-on: ubuntu-latest
    # Skip divergence check for Release Please PRs and manual dispatch on Release Please branches
    if: ${{ !startsWith(github.head_ref, 'release-please--') && !startsWith(github.ref_name, 'release-please--') }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Check out the actual PR branch, not the merge commit
          ref: ${{ github.head_ref }}
      - name: Check for divergence from base branch
        run: |
          # Use main as default base branch for manual dispatch
          BASE_BRANCH="${{ github.base_ref || 'main' }}"
          git fetch origin $BASE_BRANCH
          
          # Check how many commits behind and ahead we are
          BEHIND=$(git rev-list --count HEAD..origin/$BASE_BRANCH)
          AHEAD=$(git rev-list --count origin/$BASE_BRANCH..HEAD)
          
          echo "ğŸ“Š Branch status:"
          echo "  â€¢ Behind $BASE_BRANCH: $BEHIND commits"
          echo "  â€¢ Ahead of $BASE_BRANCH: $AHEAD commits"
          
          # Fail if branch is behind (requires update)
          if [ "$BEHIND" -gt 0 ]; then
            echo ""
            echo "âŒ DIVERGENCE DETECTED: Branch is $BEHIND commits behind $BASE_BRANCH"
            echo "ğŸ”„ Required action: Update branch with latest changes from $BASE_BRANCH"
            echo "ğŸ’¡ Use 'Update branch' button or run: git pull origin $BASE_BRANCH"
            
            # Show which commits are missing
            echo ""
            echo "ğŸ“‹ Missing commits from $BASE_BRANCH:"
            git log --oneline HEAD..origin/$BASE_BRANCH | head -5
            
            exit 1
          fi
          
          echo ""
          if [ "$AHEAD" -gt 0 ]; then
            echo "âœ… Branch is ahead by $AHEAD commits and ready to merge"
            echo "ğŸš€ No update needed - branch contains new changes"
          else
            echo "âœ… Branch is up-to-date with $BASE_BRANCH"
            echo "ğŸ’¡ No new commits to merge"
          fi

  release-please-check:
    name: ğŸ” Release Please - Divergence Allowed
    runs-on: ubuntu-latest
    # Only run for Release Please PRs or manual dispatch on Release Please branches
    if: ${{ startsWith(github.head_ref, 'release-please--') || startsWith(github.ref_name, 'release-please--') }}
    steps:
      - name: Release Please PR - Skip Divergence Check
        run: |
          echo "ğŸš€ RELEASE PLEASE PR DETECTED"
          echo "=============================="
          echo ""
          echo "âœ… This is a Release Please PR - divergence is expected and allowed"
          echo "ğŸ“‹ Release Please PRs contain new version commits and CHANGELOG updates"
          echo "ğŸ”„ No branch update required - ready for manual review and merge"
          echo ""
          echo "ğŸ’¡ Action: Review the release notes and merge when ready to release"