name: 🚀 Lighthouse Performance Testing

on:
  workflow_call:
    inputs:
      target_url:
        description: 'URL to test for performance'
        required: true
        type: string
      environment_name:
        description: 'Environment name (preview, staging, production)'
        required: true
        type: string
      budget_path:
        description: 'Path to Lighthouse budget.json file'
        required: false
        type: string
        default: './budget.json'
    outputs:
      performance_score:
        description: 'Lighthouse performance score'
        value: ${{ jobs.lighthouse-test.outputs.performance_score }}
      accessibility_score:
        description: 'Lighthouse accessibility score'
        value: ${{ jobs.lighthouse-test.outputs.accessibility_score }}
      best_practices_score:
        description: 'Lighthouse best practices score'
        value: ${{ jobs.lighthouse-test.outputs.best_practices_score }}
      seo_score:
        description: 'Lighthouse SEO score'
        value: ${{ jobs.lighthouse-test.outputs.seo_score }}
      fcp:
        description: 'First Contentful Paint'
        value: ${{ jobs.lighthouse-test.outputs.fcp }}
      lcp:
        description: 'Largest Contentful Paint'
        value: ${{ jobs.lighthouse-test.outputs.lcp }}
      cls:
        description: 'Cumulative Layout Shift'
        value: ${{ jobs.lighthouse-test.outputs.cls }}
      speed_index:
        description: 'Speed Index'
        value: ${{ jobs.lighthouse-test.outputs.speed_index }}

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  lighthouse-test:
    name: 🚀 Lighthouse Analysis
    runs-on: ubuntu-24.04-arm  # ARM64 compatible
    timeout-minutes: 10
    outputs:
      performance_score: ${{ steps.lighthouse-results.outputs.performance_score }}
      accessibility_score: ${{ steps.lighthouse-results.outputs.accessibility_score }}
      best_practices_score: ${{ steps.lighthouse-results.outputs.best_practices_score }}
      seo_score: ${{ steps.lighthouse-results.outputs.seo_score }}
      fcp: ${{ steps.lighthouse-results.outputs.fcp }}
      lcp: ${{ steps.lighthouse-results.outputs.lcp }}
      cls: ${{ steps.lighthouse-results.outputs.cls }}
      speed_index: ${{ steps.lighthouse-results.outputs.speed_index }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Wait for site availability
        run: |
          echo "🌐 Testing site availability: ${{ inputs.target_url }}"
          
          # Wait up to 5 minutes for site to be available
          timeout 300 bash -c 'until curl -f -s "${{ inputs.target_url }}" > /dev/null; do 
            echo "⏳ Waiting for site to be available..."
            sleep 10
          done'
          
          echo "✅ Site is available and ready for testing"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: 🚀 Cache Lighthouse CI Installation
        uses: actions/cache@v4
        id: lhci-cache
        with:
          path: ~/.npm
          key: lhci-${{ runner.os }}-${{ hashFiles('**/package*.json', '.github/workflows/lighthouse-testing.yml') }}
          restore-keys: |
            lhci-${{ runner.os }}-

      - name: 🌐 Setup Chrome (Minimal & ARM64 Compatible)
        uses: ./.github/actions/setup-chrome-minimal
        with:
          cache-key-suffix: 'lighthouse-${{ inputs.environment_name }}'

      - name: Run Lighthouse CI
        id: lighthouse-ci
        env:
          LHCI_GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "🚀 Installing and running Lighthouse CI with ARM64 stability improvements..."
          
          # Install Lighthouse CI with specific version for stability (cached)
          if [[ "${{ steps.lhci-cache.outputs.cache-hit }}" == "true" ]] && command -v lhci >/dev/null 2>&1; then
            echo "⚡ Lighthouse CI cache hit - installation skipped!"
          else
            echo "📥 Installing Lighthouse CI..."
            npm install -g @lhci/cli@0.15.x
          fi
          
          echo "📊 Running Lighthouse CI autorun for: ${{ inputs.target_url }}"
          echo "🔐 GitHub token configured for status checks"
          
          # Setup lighthouse config directory and copy config from infrastructure
          mkdir -p .lighthouseci
          cp infrastructure/ci/lighthouseci-config.json .lighthouseci/config.json
          
          echo "✅ Lighthouse CI config loaded from infrastructure/ci/lighthouseci-config.json"
          
          # Debug Chrome path before starting Lighthouse CI
          echo "🔍 Chrome Environment Debug:"
          echo "  CHROME_BIN: ${CHROME_BIN:-'NOT SET'}"
          echo "  LHCI_CHROME_PATH: ${LHCI_CHROME_PATH:-'NOT SET'}"
          echo "  CHROME_PATH: ${CHROME_PATH:-'NOT SET'}"
          echo "  Resolved path: ${CHROME_BIN:-/usr/bin/chromium-browser}"
          echo ""
          
          # Run with improved error handling and retry logic
          set +e  # Don't exit on error, capture output
          
          for attempt in 1 2 3; do
            echo "🔄 Attempt $attempt/3: Running Lighthouse CI..."
            
            LHCI_OUTPUT=$(lhci autorun \
              --upload.target=temporary-public-storage \
              --collect.url="${{ inputs.target_url }}" \
              --collect.settings.chromePath="${CHROME_BIN:-/usr/bin/chromium-browser}" \
              --collect.numberOfRuns=1 2>&1)
            LHCI_EXIT_CODE=$?
            
            echo "$LHCI_OUTPUT"
            
            # Check if we got valid results
            if [[ $LHCI_EXIT_CODE -eq 0 ]] && ([[ -d "./lighthouse-reports" ]] || [[ -d "./.lighthouseci" ]]); then
              echo "✅ Lighthouse CI succeeded on attempt $attempt"
              break
            elif [[ $attempt -eq 3 ]]; then
              echo "⚠️ Lighthouse CI failed after 3 attempts, but continuing with available data..."
            else
              echo "⚠️ Attempt $attempt failed, retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          set -e  # Re-enable exit on error
          
          # Extract the report URL from LHCI output (last successful one)
          REPORT_URL=$(echo "$LHCI_OUTPUT" | grep -o 'https://storage.googleapis.com/lighthouse-infrastructure.appspot.com/reports/[^[:space:]]*' | tail -1)
          if [[ -n "$REPORT_URL" ]]; then
            echo "🌐 Lighthouse Report URL: $REPORT_URL"
            echo "lighthouse_report_url=$REPORT_URL" >> $GITHUB_OUTPUT
          fi

      - name: Extract Lighthouse Results
        id: lighthouse-results
        run: |
          echo "📊 Extracting Lighthouse performance metrics..."
          
          # Look for reports in multiple locations
          RESULTS_FILE=""
          
          # First, try the new outputPath location
          if [[ -d "./lighthouse-reports" ]]; then
            RESULTS_FILE=$(find ./lighthouse-reports -name "*.json" | head -1)
          fi
          
          # Then try .lighthouseci directory for lhr-*.json files
          if [[ ! -f "$RESULTS_FILE" ]]; then
            RESULTS_FILE=$(find .lighthouseci -name "lhr-*.json" 2>/dev/null | head -1)
          fi
          
          # Try other patterns in .lighthouseci
          if [[ ! -f "$RESULTS_FILE" ]]; then
            RESULTS_FILE=$(find .lighthouseci -name "*.report.json" 2>/dev/null | head -1)
          fi
          
          # Find any JSON with categories data (excluding links.json)
          if [[ ! -f "$RESULTS_FILE" ]]; then
            for dir in ./lighthouse-reports .lighthouseci; do
              if [[ -d "$dir" ]]; then
                for file in $(find "$dir" -name "*.json" 2>/dev/null | grep -v links.json); do
                  if jq -e '.categories' "$file" >/dev/null 2>&1; then
                    RESULTS_FILE="$file"
                    break
                  fi
                done
                if [[ -f "$RESULTS_FILE" ]]; then break; fi
              fi
            done
          fi
          
          if [[ -f "$RESULTS_FILE" ]] && jq -e '.categories' "$RESULTS_FILE" >/dev/null 2>&1; then
            echo "📄 Processing results from: $RESULTS_FILE"
            
            # Extract scores (0-100) with better error handling
            PERFORMANCE=$(jq -r '.categories.performance.score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            ACCESSIBILITY=$(jq -r '.categories.accessibility.score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            BEST_PRACTICES=$(jq -r '.categories["best-practices"].score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            SEO=$(jq -r '.categories.seo.score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            
            # Extract Core Web Vitals
            FCP=$(jq -r '.audits["first-contentful-paint"].numericValue' "$RESULTS_FILE" 2>/dev/null | awk '{printf "%.0fms", $1}' || echo "N/A")
            LCP=$(jq -r '.audits["largest-contentful-paint"].numericValue' "$RESULTS_FILE" 2>/dev/null | awk '{printf "%.0fms", $1}' || echo "N/A")
            CLS=$(jq -r '.audits["cumulative-layout-shift"].numericValue' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            SPEED_INDEX=$(jq -r '.audits["speed-index"].numericValue' "$RESULTS_FILE" 2>/dev/null | awk '{printf "%.0fms", $1}' || echo "N/A")
            
            # Output results
            echo "performance_score=$PERFORMANCE" >> $GITHUB_OUTPUT
            echo "accessibility_score=$ACCESSIBILITY" >> $GITHUB_OUTPUT
            echo "best_practices_score=$BEST_PRACTICES" >> $GITHUB_OUTPUT
            echo "seo_score=$SEO" >> $GITHUB_OUTPUT
            echo "fcp=$FCP" >> $GITHUB_OUTPUT
            echo "lcp=$LCP" >> $GITHUB_OUTPUT
            echo "cls=$CLS" >> $GITHUB_OUTPUT
            echo "speed_index=$SPEED_INDEX" >> $GITHUB_OUTPUT
            
            echo "📊 Lighthouse Results Summary:"
            echo "  Performance: $PERFORMANCE/100"
            echo "  Accessibility: $ACCESSIBILITY/100"
            echo "  Best Practices: $BEST_PRACTICES/100"
            echo "  SEO: $SEO/100"
            echo "  FCP: $FCP"
            echo "  LCP: $LCP"
            echo "  CLS: $CLS"
            echo "  Speed Index: $SPEED_INDEX"
          else
            echo "⚠️ No valid Lighthouse results file found with categories data"
            echo "🔍 Debug: Files found in lighthouse directories:"
            
            for dir in ./lighthouse-reports .lighthouseci; do
              if [[ -d "$dir" ]]; then
                echo "📁 Directory: $dir"
                find "$dir" -type f -name "*.json" 2>/dev/null | while read file; do
                  echo "  - $file ($(wc -c < "$file" 2>/dev/null || echo "0") bytes)"
                  if [[ "$file" != *"links.json" ]]; then
                    echo "    Structure: $(jq -r 'keys[]?' "$file" 2>/dev/null | head -3 | tr '\n' ' ' || echo "Invalid JSON")"
                  fi
                done
              else
                echo "📁 Directory: $dir (not found)"
              fi
            done
            
            # Set N/A values
            echo "performance_score=N/A" >> $GITHUB_OUTPUT
            echo "accessibility_score=N/A" >> $GITHUB_OUTPUT
            echo "best_practices_score=N/A" >> $GITHUB_OUTPUT
            echo "seo_score=N/A" >> $GITHUB_OUTPUT
            echo "fcp=N/A" >> $GITHUB_OUTPUT
            echo "lcp=N/A" >> $GITHUB_OUTPUT
            echo "cls=N/A" >> $GITHUB_OUTPUT
            echo "speed_index=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Create Lighthouse Summary
        run: |
          echo "# 🚀 Lighthouse Performance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
          
          # Add report URL if available
          if [[ -n "${{ steps.lighthouse-ci.outputs.lighthouse_report_url }}" ]]; then
            echo "**📊 Full Report:** [${{ steps.lighthouse-ci.outputs.lighthouse_report_url }}](${{ steps.lighthouse-ci.outputs.lighthouse_report_url }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## 📊 Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Score | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ steps.lighthouse-results.outputs.performance_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.performance_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ steps.lighthouse-results.outputs.accessibility_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.accessibility_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "| Best Practices | ${{ steps.lighthouse-results.outputs.best_practices_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.best_practices_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "| SEO | ${{ steps.lighthouse-results.outputs.seo_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.seo_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ⚡ Core Web Vitals" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| First Contentful Paint | ${{ steps.lighthouse-results.outputs.fcp }} | ≤1.8s | $(echo "${{ steps.lighthouse-results.outputs.fcp }}" | sed 's/ms//' | awk '{if($1 <= 1800) print "✅ Good"; else print "⚠️ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Largest Contentful Paint | ${{ steps.lighthouse-results.outputs.lcp }} | ≤2.5s | $(echo "${{ steps.lighthouse-results.outputs.lcp }}" | sed 's/ms//' | awk '{if($1 <= 2500) print "✅ Good"; else print "⚠️ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Cumulative Layout Shift | ${{ steps.lighthouse-results.outputs.cls }} | ≤0.1 | $(echo "${{ steps.lighthouse-results.outputs.cls }}" | awk '{if($1 <= 0.1) print "✅ Good"; else print "⚠️ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Speed Index | ${{ steps.lighthouse-results.outputs.speed_index }} | ≤3.4s | $(echo "${{ steps.lighthouse-results.outputs.speed_index }}" | sed 's/ms//' | awk '{if($1 <= 3400) print "✅ Good"; else print "⚠️ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY

      - name: Post Lighthouse Report to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && steps.lighthouse-ci.outputs.lighthouse_report_url
        with:
          script: |
            const reportUrl = '${{ steps.lighthouse-ci.outputs.lighthouse_report_url }}';
            const environment = '${{ inputs.environment_name }}';
            const targetUrl = '${{ inputs.target_url }}';
            
            const comment = `## 🚀 Lighthouse Performance Report (${environment})

            **📊 Full Report:** [View Lighthouse Report](${reportUrl})
            **🌐 URL Tested:** ${targetUrl}
            
            ### Summary
            | Category | Score | Status |
            |----------|-------|--------|
            | Performance | ${{ steps.lighthouse-results.outputs.performance_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.performance_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |
            | Accessibility | ${{ steps.lighthouse-results.outputs.accessibility_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.accessibility_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |
            | Best Practices | ${{ steps.lighthouse-results.outputs.best_practices_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.best_practices_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |
            | SEO | ${{ steps.lighthouse-results.outputs.seo_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.seo_score }}" -ge "90" ] 2>/dev/null && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |
            
            ### Core Web Vitals
            - **First Contentful Paint:** ${{ steps.lighthouse-results.outputs.fcp }}
            - **Largest Contentful Paint:** ${{ steps.lighthouse-results.outputs.lcp }}
            - **Cumulative Layout Shift:** ${{ steps.lighthouse-results.outputs.cls }}
            - **Speed Index:** ${{ steps.lighthouse-results.outputs.speed_index }}
            `;
            
            // Find existing Lighthouse comment and update it
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('🚀 Lighthouse Performance Report')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

