name: ðŸš€ Lighthouse Performance Testing

on:
  workflow_call:
    inputs:
      target_url:
        description: 'URL to test for performance'
        required: true
        type: string
      environment_name:
        description: 'Environment name (preview, staging, production)'
        required: true
        type: string
      budget_path:
        description: 'Path to Lighthouse budget.json file'
        required: false
        type: string
        default: './budget.json'
      artifact_retention_days:
        description: 'How many days to retain lighthouse artifacts'
        required: false
        type: number
        default: 7
    outputs:
      performance_score:
        description: 'Lighthouse performance score'
        value: ${{ jobs.lighthouse-test.outputs.performance_score }}
      accessibility_score:
        description: 'Lighthouse accessibility score'
        value: ${{ jobs.lighthouse-test.outputs.accessibility_score }}
      best_practices_score:
        description: 'Lighthouse best practices score'
        value: ${{ jobs.lighthouse-test.outputs.best_practices_score }}
      seo_score:
        description: 'Lighthouse SEO score'
        value: ${{ jobs.lighthouse-test.outputs.seo_score }}
      fcp:
        description: 'First Contentful Paint'
        value: ${{ jobs.lighthouse-test.outputs.fcp }}
      lcp:
        description: 'Largest Contentful Paint'
        value: ${{ jobs.lighthouse-test.outputs.lcp }}
      cls:
        description: 'Cumulative Layout Shift'
        value: ${{ jobs.lighthouse-test.outputs.cls }}
      speed_index:
        description: 'Speed Index'
        value: ${{ jobs.lighthouse-test.outputs.speed_index }}

permissions:
  contents: read

jobs:
  lighthouse-test:
    name: ðŸš€ Lighthouse Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      performance_score: ${{ steps.lighthouse-results.outputs.performance_score }}
      accessibility_score: ${{ steps.lighthouse-results.outputs.accessibility_score }}
      best_practices_score: ${{ steps.lighthouse-results.outputs.best_practices_score }}
      seo_score: ${{ steps.lighthouse-results.outputs.seo_score }}
      fcp: ${{ steps.lighthouse-results.outputs.fcp }}
      lcp: ${{ steps.lighthouse-results.outputs.lcp }}
      cls: ${{ steps.lighthouse-results.outputs.cls }}
      speed_index: ${{ steps.lighthouse-results.outputs.speed_index }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Wait for site availability
        run: |
          echo "ðŸŒ Testing site availability: ${{ inputs.target_url }}"
          
          # Wait up to 5 minutes for site to be available
          timeout 300 bash -c 'until curl -f -s "${{ inputs.target_url }}" > /dev/null; do 
            echo "â³ Waiting for site to be available..."
            sleep 10
          done'
          
          echo "âœ… Site is available and ready for testing"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v2
        with:
          chrome-version: stable

      - name: Run Lighthouse CI
        id: lighthouse-ci
        run: |
          echo "ðŸš€ Installing and running Lighthouse CI (Context7 proven approach)..."
          
          # Install Lighthouse CI - Context7 recommended GitHub Actions approach
          npm install -g @lhci/cli@0.15.x
          
          echo "ðŸ“Š Running Lighthouse CI autorun for: ${{ inputs.target_url }}"
          # Google-recommended 3 runs for accurate median results
          set +e  # Don't exit on error, capture output
          LHCI_OUTPUT=$(lhci autorun \
            --upload.target=temporary-public-storage \
            --collect.url="${{ inputs.target_url }}" \
            --collect.settings.chromeFlags="--no-sandbox --disable-setuid-sandbox --headless=new" \
            --collect.numberOfRuns=3 \
            --collect.median=true \
            --collect.settings.output=json \
            --collect.settings.outputPath=./lighthouse-reports 2>&1)
          LHCI_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo "$LHCI_OUTPUT"
          
          # Extract the report URL from LHCI output
          REPORT_URL=$(echo "$LHCI_OUTPUT" | grep -o 'https://storage.googleapis.com/lighthouse-infrastructure.appspot.com/reports/[^[:space:]]*' | head -1)
          if [[ -n "$REPORT_URL" ]]; then
            echo "ðŸŒ Lighthouse Report URL: $REPORT_URL"
            echo "lighthouse_report_url=$REPORT_URL" >> $GITHUB_OUTPUT
          fi
          
          if [[ $LHCI_EXIT_CODE -ne 0 ]]; then
            echo "âš ï¸ Lighthouse CI failed but continuing..."
          fi

      - name: Extract Lighthouse Results
        id: lighthouse-results
        run: |
          echo "ðŸ“Š Extracting Lighthouse performance metrics..."
          
          # Look for reports in multiple locations
          RESULTS_FILE=""
          
          # First, try the new outputPath location
          if [[ -d "./lighthouse-reports" ]]; then
            RESULTS_FILE=$(find ./lighthouse-reports -name "*.json" | head -1)
          fi
          
          # Then try .lighthouseci directory for lhr-*.json files
          if [[ ! -f "$RESULTS_FILE" ]]; then
            RESULTS_FILE=$(find .lighthouseci -name "lhr-*.json" 2>/dev/null | head -1)
          fi
          
          # Try other patterns in .lighthouseci
          if [[ ! -f "$RESULTS_FILE" ]]; then
            RESULTS_FILE=$(find .lighthouseci -name "*.report.json" 2>/dev/null | head -1)
          fi
          
          # Find any JSON with categories data (excluding links.json)
          if [[ ! -f "$RESULTS_FILE" ]]; then
            for dir in ./lighthouse-reports .lighthouseci; do
              if [[ -d "$dir" ]]; then
                for file in $(find "$dir" -name "*.json" 2>/dev/null | grep -v links.json); do
                  if jq -e '.categories' "$file" >/dev/null 2>&1; then
                    RESULTS_FILE="$file"
                    break
                  fi
                done
                if [[ -f "$RESULTS_FILE" ]]; then break; fi
              fi
            done
          fi
          
          if [[ -f "$RESULTS_FILE" ]] && jq -e '.categories' "$RESULTS_FILE" >/dev/null 2>&1; then
            echo "ðŸ“„ Processing results from: $RESULTS_FILE"
            
            # Extract scores (0-100) with better error handling
            PERFORMANCE=$(jq -r '.categories.performance.score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            ACCESSIBILITY=$(jq -r '.categories.accessibility.score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            BEST_PRACTICES=$(jq -r '.categories["best-practices"].score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            SEO=$(jq -r '.categories.seo.score * 100 | floor' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            
            # Extract Core Web Vitals
            FCP=$(jq -r '.audits["first-contentful-paint"].numericValue' "$RESULTS_FILE" 2>/dev/null | awk '{printf "%.0fms", $1}' || echo "N/A")
            LCP=$(jq -r '.audits["largest-contentful-paint"].numericValue' "$RESULTS_FILE" 2>/dev/null | awk '{printf "%.0fms", $1}' || echo "N/A")
            CLS=$(jq -r '.audits["cumulative-layout-shift"].numericValue' "$RESULTS_FILE" 2>/dev/null || echo "N/A")
            SPEED_INDEX=$(jq -r '.audits["speed-index"].numericValue' "$RESULTS_FILE" 2>/dev/null | awk '{printf "%.0fms", $1}' || echo "N/A")
            
            # Output results
            echo "performance_score=$PERFORMANCE" >> $GITHUB_OUTPUT
            echo "accessibility_score=$ACCESSIBILITY" >> $GITHUB_OUTPUT
            echo "best_practices_score=$BEST_PRACTICES" >> $GITHUB_OUTPUT
            echo "seo_score=$SEO" >> $GITHUB_OUTPUT
            echo "fcp=$FCP" >> $GITHUB_OUTPUT
            echo "lcp=$LCP" >> $GITHUB_OUTPUT
            echo "cls=$CLS" >> $GITHUB_OUTPUT
            echo "speed_index=$SPEED_INDEX" >> $GITHUB_OUTPUT
            
            echo "ðŸ“Š Lighthouse Results Summary:"
            echo "  Performance: $PERFORMANCE/100"
            echo "  Accessibility: $ACCESSIBILITY/100"
            echo "  Best Practices: $BEST_PRACTICES/100"
            echo "  SEO: $SEO/100"
            echo "  FCP: $FCP"
            echo "  LCP: $LCP"
            echo "  CLS: $CLS"
            echo "  Speed Index: $SPEED_INDEX"
          else
            echo "âš ï¸ No valid Lighthouse results file found with categories data"
            echo "ðŸ” Debug: Files found in lighthouse directories:"
            
            for dir in ./lighthouse-reports .lighthouseci; do
              if [[ -d "$dir" ]]; then
                echo "ðŸ“ Directory: $dir"
                find "$dir" -type f -name "*.json" 2>/dev/null | while read file; do
                  echo "  - $file ($(wc -c < "$file" 2>/dev/null || echo "0") bytes)"
                  if [[ "$file" != *"links.json" ]]; then
                    echo "    Structure: $(jq -r 'keys[]?' "$file" 2>/dev/null | head -3 | tr '\n' ' ' || echo "Invalid JSON")"
                  fi
                done
              else
                echo "ðŸ“ Directory: $dir (not found)"
              fi
            done
            
            # Set N/A values
            echo "performance_score=N/A" >> $GITHUB_OUTPUT
            echo "accessibility_score=N/A" >> $GITHUB_OUTPUT
            echo "best_practices_score=N/A" >> $GITHUB_OUTPUT
            echo "seo_score=N/A" >> $GITHUB_OUTPUT
            echo "fcp=N/A" >> $GITHUB_OUTPUT
            echo "lcp=N/A" >> $GITHUB_OUTPUT
            echo "cls=N/A" >> $GITHUB_OUTPUT
            echo "speed_index=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Create Lighthouse Summary
        run: |
          echo "# ðŸš€ Lighthouse Performance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
          
          # Add report URL if available
          if [[ -n "${{ steps.lighthouse-ci.outputs.lighthouse_report_url }}" ]]; then
            echo "**ðŸ“Š Full Report:** [${{ steps.lighthouse-ci.outputs.lighthouse_report_url }}](${{ steps.lighthouse-ci.outputs.lighthouse_report_url }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Score | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ steps.lighthouse-results.outputs.performance_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.performance_score }}" -ge "90" ] 2>/dev/null && echo "âœ… Excellent" || echo "âš ï¸ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ steps.lighthouse-results.outputs.accessibility_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.accessibility_score }}" -ge "90" ] 2>/dev/null && echo "âœ… Excellent" || echo "âš ï¸ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "| Best Practices | ${{ steps.lighthouse-results.outputs.best_practices_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.best_practices_score }}" -ge "90" ] 2>/dev/null && echo "âœ… Excellent" || echo "âš ï¸ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "| SEO | ${{ steps.lighthouse-results.outputs.seo_score }}/100 | $([ "${{ steps.lighthouse-results.outputs.seo_score }}" -ge "90" ] 2>/dev/null && echo "âœ… Excellent" || echo "âš ï¸ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âš¡ Core Web Vitals" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| First Contentful Paint | ${{ steps.lighthouse-results.outputs.fcp }} | â‰¤1.8s | $(echo "${{ steps.lighthouse-results.outputs.fcp }}" | sed 's/ms//' | awk '{if($1 <= 1800) print "âœ… Good"; else print "âš ï¸ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Largest Contentful Paint | ${{ steps.lighthouse-results.outputs.lcp }} | â‰¤2.5s | $(echo "${{ steps.lighthouse-results.outputs.lcp }}" | sed 's/ms//' | awk '{if($1 <= 2500) print "âœ… Good"; else print "âš ï¸ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Cumulative Layout Shift | ${{ steps.lighthouse-results.outputs.cls }} | â‰¤0.1 | $(echo "${{ steps.lighthouse-results.outputs.cls }}" | awk '{if($1 <= 0.1) print "âœ… Good"; else print "âš ï¸ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Speed Index | ${{ steps.lighthouse-results.outputs.speed_index }} | â‰¤3.4s | $(echo "${{ steps.lighthouse-results.outputs.speed_index }}" | sed 's/ms//' | awk '{if($1 <= 3400) print "âœ… Good"; else print "âš ï¸ Needs Improvement"}') |" >> $GITHUB_STEP_SUMMARY

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ inputs.environment_name }}-${{ github.run_id }}
          path: |
            .lighthouseci/
            lhci_reports/
            lighthouse-reports/
          retention-days: ${{ inputs.artifact_retention_days }}
