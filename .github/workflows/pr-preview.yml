---
name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  packages: write
  id-token: write

jobs:
  build-and-deploy:
    name: Build & Deploy Preview
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    timeout-minutes: 15
    env:
      DOCKER_BUILDKIT: 1
      BUILDX_NO_DEFAULT_ATTESTATIONS: 1
      # Preview environment variables
      NETLIFY: 'true'
      NETLIFY_ENV: 'deploy-preview'
      REVIEW_ID: ${{ github.event.pull_request.number }}
      HEAD: ${{ github.event.pull_request.head.ref }}
      BRANCH: ${{ github.event.pull_request.head.ref }}
      CONTEXT: 'deploy-preview'
      DEPLOY_PRIME_URL: 'https://deploy-preview-${{ github.event.pull_request.number }}--resume-as-code.netlify.app'
      DEPLOY_URL: 'https://deploy-preview-${{ github.event.pull_request.number }}--resume-as-code.netlify.app'
      URL: 'https://deploy-preview-${{ github.event.pull_request.number }}--resume-as-code.netlify.app'
      NODE_ENV: 'preview'
      GITHUB_PAGES: 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate Required Secrets  # pragma: allowlist secret
        timeout-minutes: 1
        run: |
          echo "🔍 Validating required secrets for Netlify deployment..." # pragma: allowlist secret

          # Check if NETLIFY_AUTH_TOKEN exists
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then  # pragma: allowlist secret
            echo "❌ ERROR: NETLIFY_AUTH_TOKEN secret is missing"
            echo "📋 To fix this:"
            echo "1. Go to https://app.netlify.com/user/applications#personal-access-tokens"
            echo "2. Create a new personal access token"
            echo "3. Add it as NETLIFY_AUTH_TOKEN secret in GitHub repository settings"
            echo "4. URL: https://github.com/${{ github.repository }}/settings/secrets/actions" # pragma: allowlist secret
            missing_secrets=true
          else
            echo "✅ NETLIFY_AUTH_TOKEN secret found"
          fi

          # Check if NETLIFY_SITE_ID exists
          if [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then  # pragma: allowlist secret
            echo "❌ ERROR: NETLIFY_SITE_ID secret is missing"
            echo "📋 To fix this:"
            echo "1. Go to your Netlify site settings"
            echo "2. Find Site ID in Site Settings > General > Site Information"
            echo "3. Add it as NETLIFY_SITE_ID secret in GitHub repository settings"
            echo "4. URL: https://github.com/${{ github.repository }}/settings/secrets/actions" # pragma: allowlist secret
            missing_secrets=true
          else
            echo "✅ NETLIFY_SITE_ID secret found"
          fi

          # Fail if any secrets are missing
          if [ "$missing_secrets" = "true" ]; then
            echo ""
            echo "🚨 Cannot proceed with Netlify deployment - required secrets missing" # pragma: allowlist secret
            echo "💡 Alternative: Remove Netlify deployment from workflow if not needed"
            exit 1
          fi

          echo "🎉 All required secrets exist - now testing functionality..." # pragma: allowlist secret

      - name: Setup Node.js for Netlify CLI test
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Test Netlify CLI functionality
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}  # pragma: allowlist secret
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}  # pragma: allowlist secret
        timeout-minutes: 2
        uses: South-Paw/action-netlify-cli@v2
        with:
          args: status --json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Log in to Container Registry for cache
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-preview-${{ hashFiles('package*.json', 'docker/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Preview with Docker
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "🏗️ Building preview for PR #${PR_NUMBER}"
          docker buildx build \
            --file docker/Dockerfile \
            --target builder \
            --platform linux/amd64 \
            --build-arg GITHUB_SHA="${HEAD_SHA}" \
            --build-arg GITHUB_REF_NAME="${HEAD_REF}" \
            --build-arg APP_VERSION="preview-${PR_NUMBER}" \
            --build-arg BUILD_CONTEXT=pr \
            --build-arg PR_NUMBER="${PR_NUMBER}" \
            --build-arg NODE_ENV=preview \
            --build-arg NETLIFY=true \
            --build-arg NETLIFY_ENV=deploy-preview \
            --build-arg CONTEXT=deploy-preview \
            --build-arg DEPLOY_URL="${DEPLOY_URL}" \
            --build-arg DEPLOY_PRIME_URL="${DEPLOY_PRIME_URL}" \
            --cache-from type=registry,ref=ghcr.io/${{ github.repository }}-cache:golden-base \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --tag "resume:preview-${PR_NUMBER}" \
            --load \
            .

          # Update cache atomically
          if [[ -d "/tmp/.buildx-cache-new" ]]; then
            rm -rf /tmp/.buildx-cache
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache
          fi

      - name: Extract build artifacts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          mkdir -p dist
          docker run --rm -v "$PWD/dist:/tmp/dist" "resume:preview-${PR_NUMBER}" sh -c "cp -r /app/dist/* /tmp/dist/"
          echo "📁 Preview build artifacts:"
          ls -la dist/

      - name: Start build timer
        run: echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV

      - name: Deploy to Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}  # pragma: allowlist secret
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}  # pragma: allowlist secret
          PR_NUMBER: ${{ github.event.pull_request.number }}
        uses: South-Paw/action-netlify-cli@v2
        with:
          args: deploy --json --dir=dist --alias=deploy-preview-${{ env.PR_NUMBER }}

      - name: Calculate build duration
        if: always()
        run: |
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "BUILD_DURATION=${BUILD_DURATION}s" >> $GITHUB_ENV

      - name: Upload build artifacts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        uses: actions/upload-artifact@v4
        with:
          name: preview-build-${{ env.PR_NUMBER }}-${{ env.HEAD_SHA }}
          path: dist/
          retention-days: 7

  preview-info:
    name: PR Preview Information
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    needs: build-and-deploy

    steps:
      - name: Generate PR Preview Summary
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          SHORT_SHA="${HEAD_SHA:0:7}"
          SAFE_BRANCH_NAME="${BRANCH_NAME}"
          DEPLOY_URL="https://deploy-preview-${PR_NUMBER}--resume-as-code.netlify.app"

          {
            echo "## 🔍 PR Preview Environment"
            echo ""
            echo "| Resource | URL |"
            echo "|----------|-----|"
            echo "| 🌐 **Live Preview** | [View Preview](${DEPLOY_URL}) |"
            echo "| 📄 **Screen PDF** | [Screen PDF](${DEPLOY_URL}/resume.pdf) |"
            echo "| 🖨️ **Print PDF** | [Print PDF](${DEPLOY_URL}/resume-print.pdf) |"
            echo "| 🤖 **ATS PDF** | [ATS PDF](${DEPLOY_URL}/resume-ats.pdf) |"
            echo ""
            echo "### 📋 Build Information"
            echo "- **PR Number**: #${PR_NUMBER}"
            echo "- **Branch**: \`${SAFE_BRANCH_NAME}\`"
            echo "- **Commit**: \`${SHORT_SHA}\`"
            echo "- **Deploy Status**: ✅ **Ready** - GitHub Actions built & deployed to Netlify"
            echo ""
            echo "### 🧪 Quality Assurance Checklist"
            echo "- [ ] Desktop display validation"
            echo "- [ ] Mobile responsiveness check"
            echo "- [ ] PDF generation verification (all 3 versions)"
            echo "- [ ] Dark/light mode toggle functionality"
            echo "- [ ] QR code display and functionality"
            echo "- [ ] Profile image loading"
            echo "- [ ] Content rendering accuracy"
            echo "- [ ] Browser console error check"
            echo ""
            echo "> 💡 **Tip**: Preview environment automatically updates when you push new commits"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Add PR Preview Comment
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const headSha = process.env.HEAD_SHA;
            const safeBranchName = process.env.BRANCH_NAME;
            const shortSha = headSha.substring(0, 7);
            const deployUrl = `https://deploy-preview-${prNumber}--resume-as-code.netlify.app`;

            const commentBody = `## 🔍 PR Preview Environment

            | Preview | URL |
            |---------|-----|
            | 🌐 **Live Preview** | [${deployUrl}](${deployUrl}) |
            | 📄 **Screen PDF** | [Screen PDF](${deployUrl}/resume.pdf) |
            | 🖨️ **Print PDF** | [Print PDF](${deployUrl}/resume-print.pdf) |
            | 🤖 **ATS PDF** | [ATS PDF](${deployUrl}/resume-ats.pdf) |

            ### 📋 Preview Details
            - **PR**: #${prNumber}
            - **Branch**: \`${safeBranchName}\`
            - **Commit**: \`${shortSha}\`
            - **Deploy Status**: ✅ **Ready** - Built by GitHub Actions & deployed to Netlify

            > **Note**: Preview environment is now live! PDFs include QR codes pointing to this preview URL.

            ### 🧪 Testing Checklist
            - [ ] Resume displays correctly on desktop
            - [ ] Resume displays correctly on mobile
            - [ ] All three PDF versions download successfully
            - [ ] Dark/light mode toggle works
            - [ ] QR code displays and works
            - [ ] Profile image loads correctly
            - [ ] All sections render properly
            - [ ] No console errors

            ---
            *This preview will update automatically when you push new commits.*`;

            // Check if we already have a preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('## 🔍 PR Preview Environment')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
              console.log('Updated existing PR preview comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
              console.log('Created new PR preview comment');
            }

  update-deployment-status:
    name: Update PR Deployment Status
    needs: build-and-deploy
    if: github.event.action != 'closed'
    uses: ./.github/workflows/shared-deployment-status.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      deployment_status: ${{ needs.build-and-deploy.result == 'success' && 'ready' || 'failure' }}
      deployment_environment: 'preview'
      deployment_url: ${{ needs.build-and-deploy.result == 'success' && format('https://deploy-preview-{0}--resume-as-code.netlify.app', github.event.pull_request.number) || '' }}
      commit_sha: ${{ github.event.pull_request.head.sha }}
      additional_info: ${{ needs.build-and-deploy.result == 'failure' && 'Deployment failed. Check the logs for details.' || '' }}
    permissions:
      contents: read
      pull-requests: write
      issues: write

  cleanup-on-merge:
    name: Cleanup Preview Comment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Update Comment on PR Merge/Close
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const isMerged = context.payload.pull_request.merged;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const previewComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('## 📊 Deployment Status')
            );

            if (previewComment) {
              const status = isMerged ? '✅ **Merged**' : '❌ **Closed**';
              const updatedBody = previewComment.body.replace(
                /- \*\*Status\*\*: .*/,
                `- **Status**: ${status} - Preview environment deactivated`
              );

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previewComment.id,
                body: updatedBody,
              });

              const action = isMerged ? 'merged' : 'closed';
              console.log(`Updated deployment status comment for ${action} PR`);
            }
