---
name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  preview-info:
    name: PR Preview Information
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'

    steps:
      - name: Generate PR Preview Summary
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          SHORT_SHA="${HEAD_SHA:0:7}"
          SAFE_BRANCH_NAME="${BRANCH_NAME}"
          DEPLOY_URL="https://deploy-preview-${PR_NUMBER}--resume-as-code.netlify.app"

          {
            echo "## üîç PR Preview Environment"
            echo ""
            echo "| Resource | URL |"
            echo "|----------|-----|"
            echo "| üåê **Live Preview** | [View Preview](${DEPLOY_URL}) |"
            echo "| üìÑ **Screen PDF** | [Screen PDF](${DEPLOY_URL}/resume-rafael-sathler-screen.pdf) |"
            echo "| üñ®Ô∏è **Print PDF** | [Print PDF](${DEPLOY_URL}/resume-rafael-sathler-print.pdf) |"
            echo "| ü§ñ **ATS PDF** | [ATS PDF](${DEPLOY_URL}/resume-rafael-sathler-ats.pdf) |"
            echo ""
            echo "### üìã Build Information"
            echo "- **PR Number**: #${PR_NUMBER}"
            echo "- **Branch**: \`${SAFE_BRANCH_NAME}\`"
            echo "- **Commit**: \`${SHORT_SHA}\`"
            echo "- **Deploy Status**: ‚è≥ Building (Preview ready in 3-5 minutes)"
            echo ""
            echo "### üß™ Quality Assurance Checklist"
            echo "- [ ] Desktop display validation"
            echo "- [ ] Mobile responsiveness check"
            echo "- [ ] PDF generation verification (all 3 versions)"
            echo "- [ ] Dark/light mode toggle functionality"
            echo "- [ ] QR code display and functionality"
            echo "- [ ] Profile image loading"
            echo "- [ ] Content rendering accuracy"
            echo "- [ ] Browser console error check"
            echo ""
            echo "> üí° **Tip**: Preview environment automatically updates when you push new commits"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Add PR Preview Comment
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const headSha = process.env.HEAD_SHA;
            const safeBranchName = process.env.BRANCH_NAME;
            const shortSha = headSha.substring(0, 7);
            const deployUrl = `https://deploy-preview-${prNumber}--resume-as-code.netlify.app`;

            const commentBody = `## üîç PR Preview Environment

            | Preview | URL |
            |---------|-----|
            | üåê **Live Preview** | [${deployUrl}](${deployUrl}) |
            | üìÑ **Screen PDF** | [Screen PDF](${deployUrl}/resume-rafael-sathler-screen.pdf) |
            | üñ®Ô∏è **Print PDF** | [Print PDF](${deployUrl}/resume-rafael-sathler-print.pdf) |
            | ü§ñ **ATS PDF** | [ATS PDF](${deployUrl}/resume-rafael-sathler-ats.pdf) |

            ### üìã Preview Details
            - **PR**: #${prNumber}
            - **Branch**: \`${safeBranchName}\`
            - **Commit**: \`${shortSha}\`
            - **Deploy Status**: ‚è≥ Building...

            > **Note**: Preview environment will be available within 3-5 minutes.

            ### üß™ Testing Checklist
            - [ ] Resume displays correctly on desktop
            - [ ] Resume displays correctly on mobile
            - [ ] All three PDF versions download successfully
            - [ ] Dark/light mode toggle works
            - [ ] QR code displays and works
            - [ ] Profile image loads correctly
            - [ ] All sections render properly
            - [ ] No console errors

            ---
            *This preview will update automatically when you push new commits.*`;

            // Check if we already have a preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('## üîç PR Preview Environment')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
              console.log('Updated existing PR preview comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
              console.log('Created new PR preview comment');
            }

  cleanup-on-merge:
    name: Cleanup Preview Comment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Update Comment on PR Merge/Close
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const isMerged = context.payload.pull_request.merged;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const previewComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('## üîç PR Preview Environment')
            );

            if (previewComment) {
              const status = isMerged ? '‚úÖ **Merged**' : '‚ùå **Closed**';
              const updatedBody = previewComment.body.replace(
                '- **Deploy Status**: ‚è≥ Building...',
                `- **Deploy Status**: ${status} - Preview environment deactivated`
              );

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previewComment.id,
                body: updatedBody,
              });

              const action = isMerged ? 'merged' : 'closed';
              console.log(`Updated preview comment for ${action} PR`);
            }
