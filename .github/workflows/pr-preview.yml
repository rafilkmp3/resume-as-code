name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]
    paths:
      - 'src/**'
      - 'assets/**'
      - '*.html'
      - '*.json'
      - '*.js'
      - '*.css'
      - 'scripts/**'
      - 'Dockerfile'
      - 'package*.json'

permissions:
  contents: read
  pull-requests: write
  actions: read
  pages: write
  id-token: write

env:
  NODE_VERSION: '20'

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Build and deploy PR preview to separate branch
  preview-deploy:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    timeout-minutes: 8
    if: github.event.action != 'closed'
    environment:
      name: github-pages-preview
      url: ${{ steps.deployment.outputs.page_url }}pr-${{ github.event.pull_request.number }}/
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          lfs: true

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-pr-${{ github.event.pull_request.number }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-pr-${{ github.event.pull_request.number }}-
            ${{ runner.os }}-buildx-pr-
            ${{ runner.os }}-buildx-

      - name: Generate preview URL
        id: preview-url
        run: |
          PREVIEW_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}"
          echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "üì± Preview URL: $PREVIEW_URL"

      - name: Build PR preview
        env:
          PREVIEW_URL: ${{ steps.preview-url.outputs.url }}
          GITHUB_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_REF_NAME: pr-${{ github.event.pull_request.number }}
          NODE_ENV: stage
          BUILD_MODE: stage
        run: |
          echo "üèóÔ∏è Building PR preview with QR code integration"
          echo "üì± Preview URL: $PREVIEW_URL"

          docker buildx build \
            --target prod \
            --platform linux/amd64 \
            --build-arg GITHUB_SHA="$GITHUB_SHA" \
            --build-arg GITHUB_REF_NAME="$GITHUB_REF_NAME" \
            --build-arg PREVIEW_URL="$PREVIEW_URL" \
            --build-arg NODE_ENV=stage \
            --build-arg BUILD_MODE=stage \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --tag pr-preview:${{ github.event.pull_request.number }} \
            --load \
            .

          # Extract preview build from nginx html directory
          mkdir -p pr-preview-build
          docker run --rm -v "$PWD/pr-preview-build:/tmp/dist" pr-preview:${{ github.event.pull_request.number }} sh -c "cp -r /usr/share/nginx/html/* /tmp/dist/"

          # Update cache atomically
          if [[ -d "/tmp/.buildx-cache-new" ]]; then
            rm -rf /tmp/.buildx-cache
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache
          fi

          echo "üìÅ Preview build artifacts:"
          ls -la pr-preview-build/

      - name: Add PR preview banner
        run: |
          echo "üè∑Ô∏è Adding PR preview identification banner"

          # Add PR preview banner to the HTML
          sed -i 's|<body|<body style="border-top: 5px solid #ff6b35;">|g' pr-preview-build/index.html

          # Add PR preview notice at the top of the page
          sed -i 's|<body[^>]*>|&\n<div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; text-align: center; padding: 10px 20px; margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><strong>üöÄ PR PREVIEW #${{ github.event.pull_request.number }}</strong> - This is a preview deployment for testing. <a href="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}" style="color: white; text-decoration: underline;">View PR ‚Üí</a></div>|g' pr-preview-build/index.html

          echo "‚úÖ PR preview banner added to HTML"

      - name: Create PR preview directory structure
        run: |
          echo "üöÄ Preparing PR preview deployment structure"

          # Create PR subdirectory in build artifacts
          mkdir -p "pr-preview-deploy/pr-${{ github.event.pull_request.number }}"
          cp -r pr-preview-build/* "pr-preview-deploy/pr-${{ github.event.pull_request.number }}/"

          # Create a simple index.html for the preview root if it doesn't exist
          cat > pr-preview-deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>PR Previews - Resume as Code</title>
              <meta name="description" content="PR Preview Area">
              <style>
                body {
                  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                  text-align: center;
                  padding: 2rem;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  min-height: 100vh;
                  margin: 0;
                }
                .container {
                  max-width: 600px;
                  margin: 0 auto;
                  background: rgba(255,255,255,0.1);
                  padding: 2rem;
                  border-radius: 12px;
                }
                h1 { font-size: 2rem; margin-bottom: 1rem; }
                .btn {
                  display: inline-block;
                  padding: 12px 24px;
                  background: rgba(255,255,255,0.2);
                  color: white;
                  text-decoration: none;
                  border-radius: 8px;
                  margin: 1rem;
                }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ PR Preview Environment</h1>
                  <p>This area is for PR previews only.</p>
                  <a href="/" class="btn">‚Üê Back to Main Site</a>
                  <a href="pr-${{ github.event.pull_request.number }}/" class="btn">View PR #${{ github.event.pull_request.number }}</a>
              </div>
          </body>
          </html>
          EOF

          echo "üìÅ PR preview structure created:"
          ls -la pr-preview-deploy/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './pr-preview-deploy'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Update preview URL with actual deployment
        id: final-preview-url
        run: |
          FINAL_URL="${{ steps.deployment.outputs.page_url }}pr-${{ github.event.pull_request.number }}/"
          echo "url=$FINAL_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ PR preview deployed to: $FINAL_URL"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = "${{ steps.final-preview-url.outputs.url }}";
            const prNumber = context.payload.pull_request.number;
            const commentBody = `
            ## üì± PR Preview Ready! (Production-Safe)

            Your preview is deployed with **complete isolation** from production:

            ### üåê **[View Preview ‚Üí](${previewUrl})**

            **üõ°Ô∏è Production Protection:**
            - ‚úÖ **Production Unaffected**: Main site stays at root URL
            - ‚úÖ **Multiple PR Support**: Each PR gets its own subdirectory
            - ‚úÖ **Isolated Deployment**: Uses separate \`pr-previews\` branch
            - ‚úÖ **Recruiter-Safe**: Sent URLs remain stable and working

            **üöÄ Preview Features:**
            - ‚úÖ **PR Banner**: Clear identification this is a preview deployment
            - ‚úÖ **QR Code Integration**: Scan to test on mobile devices
            - ‚úÖ **Mobile Testing**: Perfect for cross-device validation
            - ‚úÖ **Live Changes**: Reflects all changes in this PR
            - ‚úÖ **Git LFS Assets**: Profile images and all assets included

            **üìä Preview Details:**
            - **URL**: \`${previewUrl}\`
            - **Commit**: \`${{ github.event.pull_request.head.sha }}\`
            - **Branch**: \`${{ github.event.pull_request.head.ref }}\`
            - **Deployment**: Separate from production (safe)

            **üì± Mobile Testing Workflow:**
            1. Open the preview link above
            2. Look for the orange **"üöÄ PR PREVIEW #${prNumber}"** banner at the top
            3. Click the QR code button in the resume
            4. Scan with your phone for instant mobile testing
            5. QR codes automatically point to this preview! üéØ

            **üîç How to Verify This is the PR Preview:**
            - Orange banner at the top: "üöÄ PR PREVIEW #${prNumber}"
            - URL shows the PR subdirectory: \`/pr-${prNumber}/\`
            - Banner links back to this PR for reference

            > üîÑ Updates automatically when you push new commits
            >
            > üõ°Ô∏è **Production guarantee**: Main site at root URL never affected
            `;

            // Find existing preview comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Preview Ready!')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  # Note: Cleanup is handled automatically by GitHub Pages deployment
  # Each PR preview deployment overwrites the previous one, so no manual cleanup needed
