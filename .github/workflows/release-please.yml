---
name: 📋 Release Management

on:
  push:
    branches:
      - main

concurrency:
  group: release-please-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-please:
    name: 📋 Update Release PR (Changelog + Version)
    runs-on: ubuntu-24.04-arm
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: 📝 Update Release PR (Release-Please)
        uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 📋 Release Process Status Summary
        run: |
          echo "## 📋 Release Process Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.release.outputs.release_created }}" = "true" ]; then
            echo "✅ **RELEASE CREATED** - Production deployment will be triggered" >> $GITHUB_STEP_SUMMARY
            echo "🚀 **Status**: Release v${{ steps.release.outputs.tag_name }} created" >> $GITHUB_STEP_SUMMARY
            echo "📋 **Next**: Production deployment workflow will automatically start" >> $GITHUB_STEP_SUMMARY
          else
            echo "📝 **RELEASE PR UPDATED** - No deployment yet" >> $GITHUB_STEP_SUMMARY
            echo "⏳ **Status**: Updated release-please PR with new commits" >> $GITHUB_STEP_SUMMARY
            echo "💡 **Next Step**: Merge the release-please PR to create a GitHub Release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📋 Current Action" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Updated release-please PR with latest commits" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Generated/updated CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Bumped version number in package.json" >> $GITHUB_STEP_SUMMARY
            echo "- ⏳ **Waiting for PR merge to create GitHub Release**" >> $GITHUB_STEP_SUMMARY
            echo "- 📝 **Note**: Production deployment happens automatically when release is published" >> $GITHUB_STEP_SUMMARY
          fi

  # 🤖 Resume-Pipeline-Bot Orchestrated Production Deployment
  trigger-production-deployment:
    name: 🚀 Trigger Production Deployment (Bot-Orchestrated)
    runs-on: ubuntu-24.04-arm
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - name: 🤖 Generate Bot Token for Enhanced Permissions
        id: bot-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      
      - name: 🚀 Trigger Production Deployment via Bot
        env:
          GH_TOKEN: ${{ steps.bot-token.outputs.token }}
          RELEASE_TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          echo "## 🤖 Bot-Orchestrated Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🚀 **Release**: $RELEASE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "🤖 **Bot**: resume-pipeline-bot (enhanced permissions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Trigger production deployment workflow with bot token
          if gh workflow run production-deploy.yml \
               --repo rafilkmp3/resume-as-code \
               --ref "$RELEASE_TAG"; then
            echo "✅ **SUCCESS**: Production deployment triggered!" >> $GITHUB_STEP_SUMMARY
            echo "🔗 **Monitor**: [GitHub Actions](https://github.com/rafilkmp3/resume-as-code/actions)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 🤖 Bot Orchestration Details" >> $GITHUB_STEP_SUMMARY
            echo "- **App**: resume-pipeline-bot" >> $GITHUB_STEP_SUMMARY
            echo "- **Permissions**: Enhanced workflow dispatch capabilities" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger**: Automatic on release creation" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **ERROR**: Failed to trigger production deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 🔧 Fallback Options" >> $GITHUB_STEP_SUMMARY
            echo "1. **Manual Trigger**: Visit [Actions](https://github.com/rafilkmp3/resume-as-code/actions/workflows/production-deploy.yml)" >> $GITHUB_STEP_SUMMARY
            echo "2. **GitHub CLI**: \`gh workflow run production-deploy.yml --ref $RELEASE_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "3. **Tag-Based**: Production will auto-trigger on next tag push" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "💡 **Note**: This release ($RELEASE_TAG) created the tag, so production deployment" >> $GITHUB_STEP_SUMMARY
            echo "should have already been triggered by the tag-based trigger mechanism." >> $GITHUB_STEP_SUMMARY
          fi

