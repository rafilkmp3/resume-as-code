---
name: ðŸ“‹ Release Management

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering from GitHub UI

concurrency:
  group: release-please-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-please:
    name: ðŸ“‹ Create Release PR for Manual Approval
    runs-on: ubuntu-24.04-arm
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      pr_created: ${{ steps.release.outputs.pr_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: ðŸ“ Release Please (PR Mode)
        uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Release Please Status Summary
        run: |
          echo "## ðŸ“‹ Release Please Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Mode**: Manual Approval via Pull Request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.release.outputs.pr_created }}" = "true" ]; then
            echo "âœ… **RELEASE PR CREATED** - Ready for manual approval" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Action Required**: Review and merge the release PR to trigger production deployment" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **PR Link**: Check [Pull Requests](https://github.com/rafilkmp3/resume-as-code/pulls) for the release PR" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.release.outputs.release_created }}" = "true" ]; then
            echo "âœ… **RELEASE CREATED** - Production deployment will be triggered" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Status**: Release v${{ steps.release.outputs.tag_name }} created from merged PR" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Next**: Production deployment workflow will automatically start" >> $GITHUB_STEP_SUMMARY
          else
            echo "â³ **NO CHANGES** - No conventional commits since last release" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Status**: All commits are already included in previous releases" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Note**: A release PR will be created on next conventional commit" >> $GITHUB_STEP_SUMMARY
          fi

  # ðŸ¤– Resume-Pipeline-Bot Orchestrated Production Deployment
  trigger-production-deployment:
    name: ðŸš€ Trigger Production Deployment (Bot-Orchestrated)
    runs-on: ubuntu-24.04-arm
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - name: ðŸ¤– Generate Bot Token for Enhanced Permissions
        id: bot-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      
      - name: ðŸš€ Trigger Production Deployment via Bot
        env:
          GH_TOKEN: ${{ steps.bot-token.outputs.token }}
          RELEASE_TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          echo "## ðŸ¤– Bot-Orchestrated Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Release**: $RELEASE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– **Bot**: resume-pipeline-bot (enhanced permissions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Trigger production deployment workflow with bot token
          if gh workflow run production-deployment.yml \
               --repo rafilkmp3/resume-as-code \
               --ref "$RELEASE_TAG"; then
            echo "âœ… **SUCCESS**: Production deployment triggered!" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Monitor**: [GitHub Actions](https://github.com/rafilkmp3/resume-as-code/actions)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ¤– Bot Orchestration Details" >> $GITHUB_STEP_SUMMARY
            echo "- **App**: resume-pipeline-bot" >> $GITHUB_STEP_SUMMARY
            echo "- **Permissions**: Enhanced workflow dispatch capabilities" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger**: Automatic on release creation" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ERROR**: Failed to trigger production deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Fallback Options" >> $GITHUB_STEP_SUMMARY
            echo "1. **Manual Trigger**: Visit [Actions](https://github.com/rafilkmp3/resume-as-code/actions/workflows/production-deployment.yml)" >> $GITHUB_STEP_SUMMARY
            echo "2. **GitHub CLI**: \`gh workflow run production-deployment.yml --ref $RELEASE_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "3. **Tag-Based**: Production will auto-trigger on next tag push" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Note**: This release ($RELEASE_TAG) created the tag, so production deployment" >> $GITHUB_STEP_SUMMARY
            echo "should have already been triggered by the tag-based trigger mechanism." >> $GITHUB_STEP_SUMMARY
          fi

