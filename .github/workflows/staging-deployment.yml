---
name: ğŸš€ Staging Deploy (Regular Commits Only)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: staging-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_ENV: production
  NETLIFY_ENV: staging

jobs:
  build-staging:
    name: ğŸ—ï¸ Build Staging
    # ğŸš« SIMPLE CHECK: Skip if release commit
    if: "!startsWith(github.event.head_commit.message, 'chore(release):')"
    uses: ./.github/workflows/shared-build.yml
    with:
      build-context: 'staging'
      deploy-url: 'https://resume-as-code.netlify.app'
      cache-key-suffix: 'staging-arm64'

  deploy-staging:
    name: ğŸš€ Deploy Staging  
    needs: build-staging
    # ğŸš« SIMPLE CHECK: Skip if release commit  
    if: "!startsWith(github.event.head_commit.message, 'chore(release):')"
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10
    env:
      NODE_ENV: production
      NETLIFY_ENV: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: ./.github/actions/manage-artifacts
        with:
          action: 'download'
          build-context: 'staging'

      - name: Deploy to Netlify Staging
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        uses: South-Paw/action-netlify-cli@v2
        with:
          args: deploy --json --dir=workspace/build --prod --skip-functions-cache

      - name: Verify Staging Deployment
        run: |
          echo "ğŸ” Verifying staging deployment accessibility..."
          STAGING_URL="https://resume-as-code.netlify.app"
          
          # Wait for deployment to be accessible
          for i in {1..30}; do
            echo "ğŸŒ Attempt $i/30: Testing $STAGING_URL"
            if curl -f -s -L "$STAGING_URL" > /dev/null; then
              echo "âœ… Staging deployment is accessible"
              break
            fi
            
            if [[ $i -eq 30 ]]; then
              echo "âŒ Staging deployment verification failed"
              exit 1
            fi
            
            echo "â³ Waiting 10 seconds before retry..."
            sleep 10
          done

      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Test Version API Endpoint
        run: |
          echo "ğŸ§ª Testing version API endpoint in staging..."
          STAGING_URL="https://resume-as-code.netlify.app"
          
          # Test dynamic API version endpoint
          echo "ğŸ“‹ Testing /api/version (Astro API route)..."
          if curl -f -s "$STAGING_URL/api/version" | jq . > /dev/null; then
            echo "âœ… /api/version endpoint is accessible and returns valid JSON"
            echo "ğŸ“Š Version Information:"
            API_RESPONSE=$(curl -s "$STAGING_URL/api/version")
            echo "$API_RESPONSE" | jq .
            
            # Extract key information for validation
            GIT_HASH=$(echo "$API_RESPONSE" | jq -r '.git.shortHash // "unknown"')
            BRANCH=$(echo "$API_RESPONSE" | jq -r '.git.branch // "unknown"')
            SITE_URL=$(echo "$API_RESPONSE" | jq -r '.siteUrl // "unknown"')
            
            echo ""
            echo "ğŸ” Validation Summary:"
            echo "  - Git Hash: $GIT_HASH"
            echo "  - Branch: $BRANCH"
            echo "  - Site URL: $SITE_URL"
            echo "  - Environment: $(echo "$API_RESPONSE" | jq -r '.environment.context // "unknown"')"
            echo "  - Node Version: $(echo "$API_RESPONSE" | jq -r '.environment.nodeVersion // "unknown"')"
            echo "  - Architecture: $(echo "$API_RESPONSE" | jq -r '.environment.arch // "unknown"')"
            
          else
            echo "âŒ /api/version endpoint failed"
            exit 1
          fi
          
          # Test legacy endpoints for backward compatibility (optional)
          echo "ğŸ“‹ Testing legacy endpoints..."
          if curl -f -s "$STAGING_URL/version.json" > /dev/null 2>&1; then
            echo "âœ… Legacy /version.json still accessible"
          else
            echo "â„¹ï¸ Legacy /version.json not found (expected with new API)"
          fi

      - name: Generate User-Friendly Step Summary
        if: always()
        run: |
          # Determine deployment status dynamically
          if [ "${{ job.status }}" = "success" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="Deployment Complete"
            STATUS_COLOR="ğŸŸ¢"
          elif [ "${{ job.status }}" = "failure" ]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="Deployment Failed"
            STATUS_COLOR="ğŸ”´"
          else
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="Deployment ${{ job.status }}"
            STATUS_COLOR="ğŸŸ¡"
          fi
          
          # Get current timestamp
          DEPLOY_TIME=$(TZ='America/Sao_Paulo' date '+%d/%m/%Y %H:%M:%S BRT (%Y-%m-%d %H:%M:%S UTC)')
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          COMMIT_MSG=$(git log -1 --format=%s 2>/dev/null || echo "unknown")
          
          echo "## ğŸš€ Netlify Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${STATUS_ICON} ${STATUS_TEXT}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Netlify Staging (main branch)" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://resume-as-code.netlify.app" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed**: ${DEPLOY_TIME}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${COMMIT_HASH}\` - ${COMMIT_MSG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Build Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ needs.build-staging.outputs.build-size }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${{ needs.build-staging.outputs.build-duration }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner**: ARM64 (40% faster than AMD64)" >> $GITHUB_STEP_SUMMARY
          echo "- **Framework**: Astro v5.13.3" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only show validation if deployment succeeded
          if [ "${{ job.status }}" = "success" ]; then
            echo "### ğŸ“‹ Validation Results" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Main site accessible and responsive" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… /api/version (Astro API route) working" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Dynamic version information with git metadata" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… All 3 PDF variants generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ [Live Site](https://resume-as-code.netlify.app)" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š [Version API](https://resume-as-code.netlify.app/api/version)" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“„ [Screen PDF](https://resume-as-code.netlify.app/resume.pdf)" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ–¨ï¸ [Print PDF](https://resume-as-code.netlify.app/resume-print.pdf)" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ¤– [ATS PDF](https://resume-as-code.netlify.app/resume-ats.pdf)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "- Check [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Netlify secrets configuration" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure build artifacts were uploaded correctly" >> $GITHUB_STEP_SUMMARY
          fi

  # ğŸ” FIND RELEASE-PLEASE PR FOR RESULTS POSTING
  find-release-pr:
    name: ğŸ” Find Release PR
    runs-on: ubuntu-latest
    if: needs.deploy-staging.result == 'success' && !startsWith(github.event.head_commit.message, 'chore(release):')
    needs: [build-staging, deploy-staging]
    outputs:
      pr_number: ${{ steps.find-pr.outputs.pr_number }}
    steps:
      - name: Find Release-Please PR
        id: find-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Search for open release-please PR
          RELEASE_PR=$(gh pr list --repo ${{ github.repository }} --search "chore(release)" --state open --json number --jq '.[0].number // empty' || echo "")
          if [ -n "$RELEASE_PR" ]; then
            echo "pr_number=$RELEASE_PR" >> $GITHUB_OUTPUT
            echo "âœ… Found release-please PR #$RELEASE_PR for staging test results"
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No open release-please PR found for staging test results"
          fi

  # ğŸš€ POST-DEPLOYMENT LIGHTHOUSE TESTING
  lighthouse-staging:
    name: ğŸš€ Lighthouse (Staging)
    needs: [build-staging, deploy-staging, find-release-pr]
    if: needs.deploy-staging.result == 'success' && !startsWith(github.event.head_commit.message, 'chore(release):')
    uses: ./.github/workflows/comprehensive-testing.yml
    with:
      target_url: 'https://resume-as-code.netlify.app'
      environment_name: 'staging'
      environment_context: '${{ github.ref_name }}'
      test_types: 'lighthouse,accessibility,performance'
      lighthouse_budget_path: './budget.json'
      artifact_retention_days: 3
      post_pr_comment: true
      pr_number: '${{ needs.find-release-pr.outputs.pr_number }}'

  # ğŸ¯ POST STAGING RESULTS TO RELEASE-PLEASE PR
  post-to-release-please:
    name: ğŸ“‹ Update PR Status
    needs: [build-staging, deploy-staging, lighthouse-staging] 
    # ğŸš« SIMPLE CHECK: Skip if release commit
    if: "always() && !startsWith(github.event.head_commit.message, 'chore(release):')"
    uses: ./.github/workflows/deployment-status.yml
    with:
      deployment_status: ${{ needs.deploy-staging.result == 'success' && 'ready' || 'failure' }}
      deployment_url: 'https://resume-as-code.netlify.app'
      deployment_environment: 'staging'
      additional_info: |
        ### ğŸ§ª Staging Test Results
        - âœ… **Build**: ARM64 reusable workflow successful
        - âœ… **Deploy**: Netlify staging deployment complete  
        - âœ… **Lighthouse**: ${{ needs.lighthouse-staging.result == 'success' && 'Performance testing complete' || 'Skipped or failed' }}
        - âœ… **Version Endpoint**: /version.json accessible and valid
        - âœ… **Build Duration**: ${{ needs.build-staging.outputs.build-duration }}s  
        - âœ… **Build Size**: ${{ needs.build-staging.outputs.build-size }}
        - ğŸƒâ€â™‚ï¸ **Runner**: ARM64 architecture for 40% performance boost
        
        ### ğŸ“Š Environment Info
        - **URL**: https://resume-as-code.netlify.app
        - **Environment**: Netlify Staging (main branch)
        - **Branch**: main
        - **Build**: Production mode with staging environment variables