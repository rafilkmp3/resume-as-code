---
name: 🚀 Staging Deploy (Netlify)

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'assets/**' 
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

concurrency:
  group: staging-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_ENV: production
  NETLIFY_ENV: staging

jobs:
  # Check if this is a release-please commit to avoid duplicate deployments
  check-release-context:
    name: 🔍 Detect Release Commits (Skip Staging if Release-Please)
    runs-on: ubuntu-latest-arm64
    outputs:
      should_deploy_staging: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 2
      - name: 🔍 Analyze Commit Message & Author
        id: check
        run: |
          # Get commit info using git log (secure approach)
          COMMIT_MSG=$(git log --format=%s -n 1 ${{ github.sha }})
          COMMIT_AUTHOR=$(git log --format=%an -n 1 ${{ github.sha }})
          
          echo "📝 Commit message: $COMMIT_MSG"
          echo "👤 Commit author: $COMMIT_AUTHOR"
          
          if echo "$COMMIT_MSG" | grep -q "chore(release):" || \
             echo "$COMMIT_MSG" | grep -q "chore: release" || \
             echo "$COMMIT_AUTHOR" | grep -q "release-please"; then
            echo "🚫 SKIPPING: This is a release-please commit"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "✅ PROCEEDING: Regular commit, deploying to staging"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy-staging:
    name: 🚀 Deploy to Netlify Staging  
    needs: check-release-context
    if: needs.check-release-context.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Build for Staging
        run: npm run build
      - name: Deploy to Netlify (Echo Only)
        run: |
          echo "🚀 Would deploy to Netlify staging here"
          echo "✅ Staging deployment simulation completed successfully"