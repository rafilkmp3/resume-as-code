---
name: ðŸš€ Local Development Workflow (Act Compatible)

on:
  workflow_dispatch:
    inputs:
      force_local:
        description: 'Force local environment (bypass Docker)'
        required: false
        type: boolean
        default: false
  push:
    branches-ignore:
      - main  # Avoid conflicts with production workflows

env:
  # Detect if running in act (local) or GitHub Actions (CI)
  RUN_LOCAL: ${{ github.event.inputs.force_local || 'false' }}
  NODE_ENV: development

jobs:
  environment-detection:
    name: ðŸ” Environment Detection
    runs-on: ubuntu-latest
    outputs:
      run_local: ${{ steps.detect.outputs.run_local }}
      environment: ${{ steps.detect.outputs.environment }}
    steps:
      - name: Detect execution environment
        id: detect
        run: |
          echo "ðŸ” Detecting execution environment..."
          
          # Check if running in act (local)
          if [ "$ACT" = "true" ] || [ "${{ github.event.inputs.force_local }}" = "true" ]; then
            echo "ðŸ  Running in LOCAL environment (act)"
            echo "run_local=true" >> $GITHUB_OUTPUT
            echo "environment=local" >> $GITHUB_OUTPUT
          else
            echo "â˜ï¸  Running in CI environment (GitHub Actions)"
            echo "run_local=false" >> $GITHUB_OUTPUT
            echo "environment=ci" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ“Š Environment variables:"
          echo "  - ACT: $ACT"
          echo "  - RUN_LOCAL: ${{ env.RUN_LOCAL }}"
          echo "  - NODE_ENV: ${{ env.NODE_ENV }}"
          echo "  - Runner OS: ${{ runner.os }}"

  local-development:
    name: ðŸ  Local Development Build
    runs-on: ubuntu-latest
    needs: environment-detection
    if: needs.environment-detection.outputs.run_local == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js (Local Mode)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies (Local Mode)
        run: |
          echo "ðŸ“¦ Installing dependencies in local mode..."
          echo "âš¡ No Docker required - using host Node.js environment"
          npm ci

      - name: Build project (Local Mode)
        env:
          RUN_LOCAL: true
          NODE_ENV: development
        run: |
          echo "ðŸ—ï¸ Building project in local mode..."
          echo "âš¡ No Docker containers - direct Node.js execution"
          npm run build

      - name: Run tests (Local Mode) 
        env:
          RUN_LOCAL: true
        run: |
          echo "ðŸ§ª Running tests in local mode..."
          echo "âš¡ Fast execution - no container overhead"
          npm test

      - name: Local development summary
        run: |
          echo "# ðŸ  Local Development Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Local (act)" >> $GITHUB_STEP_SUMMARY
          echo "**Node.js Version:** $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "**npm Version:** $(npm --version)" >> $GITHUB_STEP_SUMMARY
          echo "**Build Mode:** Development (RUN_LOCAL=true)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš¡ Performance Benefits" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No Docker container overhead" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Direct host Node.js execution" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Faster iteration cycles" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Reproducible GitHub Actions locally" >> $GITHUB_STEP_SUMMARY

  ci-development:
    name: â˜ï¸ CI Development Build
    runs-on: ubuntu-latest
    needs: environment-detection
    if: needs.environment-detection.outputs.run_local == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with Docker (CI Mode)
        run: |
          echo "ðŸ³ Building with Docker in CI mode..."
          echo "â˜ï¸  Using containerized environment"
          make build

      - name: Test with Docker (CI Mode)
        run: |
          echo "ðŸ§ª Running tests with Docker in CI mode..."
          echo "â˜ï¸  Full containerized testing"
          make test-fast

      - name: CI development summary
        run: |
          echo "# â˜ï¸ CI Development Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** CI (GitHub Actions)" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Version:** $(docker --version)" >> $GITHUB_STEP_SUMMARY
          echo "**Build Mode:** Docker Compose" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ³ Docker Benefits" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Environment parity (ARM64 vs AMD64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Isolated dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Consistent cross-platform behavior" >> $GITHUB_STEP_SUMMARY

  development-comparison:
    name: ðŸ“Š Development Comparison
    runs-on: ubuntu-latest
    needs: [environment-detection, local-development, ci-development]
    if: always()
    steps:
      - name: Environment comparison summary
        run: |
          echo "# ðŸ“Š Development Environment Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ  Local Development (act)" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance:** âš¡ Fastest (no container overhead)" >> $GITHUB_STEP_SUMMARY
          echo "- **Setup:** ðŸš€ Minimal (uses host Node.js)" >> $GITHUB_STEP_SUMMARY
          echo "- **Use Case:** ðŸ’» Development iteration, testing act workflows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â˜ï¸ CI Development (GitHub Actions)" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance:** ðŸ³ Standard (container overhead)" >> $GITHUB_STEP_SUMMARY
          echo "- **Setup:** ðŸ”§ Complete (Docker + dependencies)" >> $GITHUB_STEP_SUMMARY
          echo "- **Use Case:** ðŸŒ CI/CD, cross-platform validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recommendation:** Use local for rapid development, CI for validation"